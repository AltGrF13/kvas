#!/bin/sh
#------------------------------------------------------------------------------
#
# ПАКЕТ КВАС
#
# ------------------------------------------------------------------------------
# Разработчик: mail@zeleza.ru
# Дата создания: 19.11.2024
# Лицензия: Apache License 2.0
# ------------------------------------------------------------------------------

. /opt/apps/kvas/bin/libs/main

HOST_LIST=/opt/etc/kvas.list
IPSET_TABLE_NAME=kvas_ipset
IP_FILTER='[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}'
REGEXP_IP_OR_RANGE="${IP_FILTER}|${IP_FILTER}-${IP_FILTER}|${IP_FILTER}/[0-9]{1,2}"

log_warning 'Начат периодический переобход доменов из списка'

add_host_by_iplist_to_ipset() {
	host=${1//\*/}

	# получаем список из адресов от текущего dns сервера
	# и исключаем из списка адреса типа 0.0.0.0
	ip_list=$(get_iplist_from_domain "${host}" \
	 | grep -Eo "${IP_FILTER}" \
	 | grep -v '0.0.0.0' )

	if [ -z "${ip_list}" ]; then
		return
	fi

	for ip in ${ip_list}; do
		# если уже есть в списке
		if ipset list "${IPSET_TABLE_NAME}" | grep -q "${ip}" ; then
			continue
		fi

		ipset -exist add "${IPSET_TABLE_NAME}" "${ip}"
		log_warning "Обнаружен новый IP ${ip} для домена ${host} и успешно добавлен в ipset"
	done
}

# проверяем доступность сети
until ADDRS=$(kdig +short ya.ru @127.0.0.1:9153 ) && [ -n "${ADDRS}" ] > /dev/null 2>&1; do sleep 5; done

# обновляем таблицу ipset данными из файла с доменными именами, IP и сетями
while read -r line || [ -n "${line}" ]; do
	# пропускаем строки c минусами - это рекламные сайты
	# пропускаем пустые строки
	# пропускаем строки с комментариями
	[ "${line::1}" = "-" ] || [ -z "${line}" ] || [ "${line:0:1}" = "#" ] && continue

	# удаляем из строки комментарии - все что встречается после символа # и сам символ
	# удаляем *
	host=$(echo "${line}" | sed 's/#.*$//g' | tr -s ' ' | sed 's/\*//')

	# если строка IP, диапазон или маска
	if echo "${host}" | grep -qE -- "${REGEXP_IP_OR_RANGE}"; then
		continue
	fi

	add_host_by_iplist_to_ipset "${host}"
done < "${HOST_LIST}"
