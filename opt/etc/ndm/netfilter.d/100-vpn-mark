#!/bin/sh

#------------------------------------------------------------------------------
#
#	ПАКЕТ КВАС
#
#------------------------------------------------------------------------------
#
#	Данный файл служит для создания новых правил маркировки трафика по протоколу IPv4
#	при использовании VPN подключения отличного от shadowsocks.
#	Они срабатывают при перезаписи правил в таблице netfilter
#	https://github.com/ndmsystems/packages/wiki/Opkg-Component
#	основными задачами являются:
#
#	1. Создание kvas таблицы для ipset ip4
#	2. Проверка на наличие ускорения трафика (аппаратное и программное)
#	3. В зависимости от наличия ускорения включаем те или иные правила маркировки трафика
#
# ------------------------------------------------------------------------------
#	Разработчик: mail@zeleza.ru
#	Дата создания: 21/05/2022
#	Лицензия: Apache License 2.0
# ------------------------------------------------------------------------------

if [ "${type}" = 'iptables' ] ; then
	. /opt/apps/kvas/bin/libs/ndm

	# обе функции используют только mangle
	# кроме маркировки включают обход br0
	if [ "${table}" = 'mangle' ] ; then
		if fastnet_enabled ; then
			ip4__vpn_fast__create_chain &>/dev/null
			ip4__vpn_fast__add_routing_for_home &>/dev/null
		else
			ip4_firewall_mark_rules_tcp_udp_on &>/dev/null
		fi
	fi

	# обход с ускорением использует mangle
	# роутинг DNS гостевых и обход без ускорения используют nat
	if [ "${table}" = 'mangle' ] || [ "${table}" = 'nat' ] ; then
		set_guest_nets_rules &>/dev/null
	fi
fi
